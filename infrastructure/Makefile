# Atlas Travel Advisor - CLI Shortcuts
# Usage: make <command>

.PHONY: help start stop build test eval clean logs shell-backend shell-frontend lint format pre-commit-install

# Default target
help:
	@echo "Atlas Travel Advisor - Available Commands:"
	@echo ""
	@echo "ğŸš€ Development:"
	@echo "  make start      - Start all services with Docker Compose"
	@echo "  make stop       - Stop all running services"
	@echo "  make build      - Build all Docker images"
	@echo "  make restart    - Restart all services (stop + start)"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test       - Run the complete test suite"
	@echo "  make test-unit  - Run unit tests only"
	@echo "  make test-int   - Run integration tests only"
	@echo ""
	@echo "ğŸ“Š Evaluation:"
	@echo "  make eval       - Run AI evaluation scenarios"
	@echo ""
	@echo "ğŸ”§ Utilities:"
	@echo "  make logs       - Show logs from all services"
	@echo "  make logs-backend - Show backend logs only"
	@echo "  make logs-frontend - Show frontend logs only"
	@echo "  make shell-backend - Open shell in backend container"
	@echo "  make shell-frontend - Open shell in frontend container"
	@echo "  make clean      - Clean up containers and volumes"
	@echo ""
	@echo "ğŸ§¹ Code Quality:"
	@echo "  make lint       - Run linters on all Python code"
	@echo "  make format     - Format all Python code with black and isort"
	@echo "  make pre-commit-install - Install pre-commit hooks"
	@echo "  make pre-commit-run - Run pre-commit hooks on all files"
	@echo ""
	@echo "ğŸ“š Database:"
	@echo "  make db-migrate - Run database migrations"
	@echo "  make db-upgrade - Upgrade database to latest migration"
	@echo "  make db-reset   - Reset database (WARNING: destroys data)"
	@echo ""
	@echo "ğŸŒ Quick Access:"
	@echo "  Frontend: http://localhost:8501"
	@echo "  Backend API: http://localhost:8000"
	@echo "  API Docs: http://localhost:8000/docs"

# Development Commands
start:
	@echo "ğŸš€ Starting Atlas Travel Advisor services..."
	docker compose up -d
	@echo "âœ… Services started!"
	@echo "   Frontend: http://localhost:8501"
	@echo "   Backend: http://localhost:8000"
	@echo "   API Docs: http://localhost:8000/docs"

stop:
	@echo "ğŸ›‘ Stopping all services..."
	docker compose down
	@echo "âœ… Services stopped!"

build:
	@echo "ğŸ”¨ Building all Docker images..."
	docker compose build
	@echo "âœ… Build complete!"

restart: stop start

# Testing Commands
test:
	@echo "ğŸ§ª Running complete test suite..."
	@echo "ğŸ“‹ Running unit tests..."
	docker compose exec backend python -m pytest tests/unit/ -v
	@echo "ğŸ“‹ Running integration tests..."
	docker compose exec backend python -m pytest tests/integration/ -v
	@echo "âœ… All tests complete!"

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	docker compose exec backend python -m pytest tests/unit/ -v

test-int:
	@echo "ğŸ§ª Running integration tests..."
	docker compose exec backend python -m pytest tests/integration/ -v

# Evaluation Commands
eval:
	@echo "ğŸ“Š Running AI evaluation scenarios..."
	docker compose exec backend python eval/run_scenarios.py
	@echo "âœ… Evaluation complete!"

# Utility Commands
logs:
	docker compose logs -f

logs-backend:
	docker compose logs -f backend

logs-frontend:
	docker compose logs -f frontend

shell-backend:
	docker compose exec backend /bin/bash

shell-frontend:
	docker compose exec frontend /bin/bash

clean:
	@echo "ğŸ§¹ Cleaning up containers and volumes..."
	docker compose down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup complete!"

# Database Commands
db-migrate:
	@echo "ğŸ“Š Generating database migration..."
	docker compose exec backend alembic revision --autogenerate -m "Auto migration"

db-upgrade:
	@echo "ğŸ“Š Upgrading database to latest migration..."
	docker compose exec backend alembic upgrade head

db-reset:
	@echo "âš ï¸  WARNING: This will destroy all data!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	docker compose down -v
	docker compose up -d db redis
	sleep 5
	docker compose exec backend alembic upgrade head
	@echo "âœ… Database reset complete!"

# Development helpers
dev-setup:
	@echo "ğŸ”§ Setting up development environment..."
	cp .env.example .env
	@echo "ğŸ“ Please edit .env file with your configuration"
	@echo "âœ… Development setup complete!"

# Health check
health:
	@echo "ğŸ¥ Checking service health..."
	@curl -s http://localhost:8000/api/v1/ops/healthz || echo "âŒ Backend not responding"
	@curl -s http://localhost:8501 > /dev/null && echo "âœ… Frontend is healthy" || echo "âŒ Frontend not responding"

# Install dependencies (for local development)
install-backend:
	cd backend && pip install -r requirements.txt

install-frontend:
	cd frontend && pip install -r requirements.txt

install: install-backend install-frontend

# Code Quality Commands
lint:
	@echo "ğŸ§¹ Running linters on all Python code..."
	@echo "ğŸ“‹ Running flake8..."
	flake8 backend/ frontend/ --config=pyproject.toml
	@echo "ğŸ“‹ Running mypy..."
	mypy backend/ frontend/
	@echo "âœ… Linting complete!"

format:
	@echo "ğŸ¨ Formatting all Python code..."
	@echo "ğŸ“‹ Running black..."
	black backend/ frontend/
	@echo "ğŸ“‹ Running isort..."
	isort backend/ frontend/
	@echo "âœ… Formatting complete!"

pre-commit-install:
	@echo "ğŸ”§ Installing pre-commit hooks..."
	pre-commit install
	@echo "âœ… Pre-commit hooks installed!"
	@echo "ğŸ’¡ Now every commit will automatically run linters and formatters"

pre-commit-run:
	@echo "ğŸ”§ Running pre-commit hooks on all files..."
	pre-commit run --all-files
	@echo "âœ… Pre-commit run complete!"
